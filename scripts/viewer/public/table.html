<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table View - Enrichment Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <a href="/" class="text-blue-600 hover:text-blue-700 font-medium">‚Üê Back</a>
            <h1 class="text-xl font-bold text-gray-900">üìã Table View</h1>
            <a href="/workflow.html" class="text-blue-600 hover:text-blue-700 font-medium">Workflow ‚Üí</a>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Controls -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
            <div class="grid md:grid-cols-3 gap-4">
                <!-- Search -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="Search in all columns..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                </div>

                <!-- Column filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Show Columns</label>
                    <select
                        id="columnFilter"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="all">All Columns</option>
                        <option value="enriched">Enriched Only</option>
                        <option value="original">Original Only</option>
                    </select>
                </div>

                <!-- Export -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Actions</label>
                    <button
                        id="exportBtn"
                        class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                    >
                        üì• Export CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Table Container -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div id="tableContainer" class="overflow-x-auto">
                <div class="flex items-center justify-center p-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                    <span class="ml-3 text-gray-600">Loading data...</span>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="mt-6 flex items-center justify-between"></div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const rowsPerPage = 25;
        let sortColumn = null;
        let sortDirection = 'asc';

        const originalColumns = ['name', 'email', 'linkedin_url', 'company', 'source'];

        // Load data
        async function loadData() {
            const res = await fetch('/api/data');
            allData = await res.json();
            filteredData = [...allData];
            renderTable();
        }

        // Render table
        function renderTable() {
            const container = document.getElementById('tableContainer');
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="p-12 text-center text-gray-500">No data to display</div>';
                return;
            }

            // Get visible columns
            const columnFilter = document.getElementById('columnFilter')?.value || 'all';
            const allColumns = Object.keys(filteredData[0]);
            let visibleColumns = allColumns;

            if (columnFilter === 'enriched') {
                visibleColumns = allColumns.filter(col => !originalColumns.includes(col));
            } else if (columnFilter === 'original') {
                visibleColumns = allColumns.filter(col => originalColumns.includes(col));
            }

            // Pagination
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = filteredData.slice(start, end);

            // Build table
            let html = '<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';

            visibleColumns.forEach(col => {
                const isSorted = sortColumn === col;
                const arrow = isSorted ? (sortDirection === 'asc' ? ' ‚Üë' : ' ‚Üì') : '';
                html += `
                    <th
                        class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                        onclick="sortBy('${col}')"
                    >
                        ${col}${arrow}
                    </th>
                `;
            });

            html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';

            pageData.forEach((row, i) => {
                html += `<tr class="${i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">`;
                visibleColumns.forEach(col => {
                    const value = row[col] || '';
                    const truncated = value.length > 50 ? value.substring(0, 47) + '...' : value;
                    html += `<td class="px-4 py-3 text-sm text-gray-900">${truncated}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            // Render pagination
            renderPagination();
        }

        // Sort
        function sortBy(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            filteredData.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';

                // Try numeric comparison
                const aNum = parseFloat(aVal);
                const bNum = parseFloat(bVal);
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return sortDirection === 'asc' ? aNum - bNum : bNum - aNum;
                }

                // String comparison
                return sortDirection === 'asc'
                    ? aVal.localeCompare(bVal)
                    : bVal.localeCompare(aVal);
            });

            renderTable();
        }
        window.sortBy = sortBy;

        // Search
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            searchInput?.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                filteredData = allData.filter(row =>
                    Object.values(row).some(val =>
                        String(val).toLowerCase().includes(query)
                    )
                );
                currentPage = 1;
                renderTable();
            });

            // Column filter
            const columnFilter = document.getElementById('columnFilter');
            columnFilter?.addEventListener('change', () => {
                renderTable();
            });

            // Export
            const exportBtn = document.getElementById('exportBtn');
            exportBtn?.addEventListener('click', exportCSV);
        });

        // Pagination
        function renderPagination() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            const container = document.getElementById('pagination');

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = `
                <div class="text-sm text-gray-600">
                    Showing ${(currentPage - 1) * rowsPerPage + 1} to ${Math.min(currentPage * rowsPerPage, filteredData.length)} of ${filteredData.length} rows
                </div>
                <div class="flex space-x-2">
            `;

            if (currentPage > 1) {
                html += `<button onclick="changePage(${currentPage - 1})" class="px-3 py-1 border rounded hover:bg-gray-50">‚Üê Prev</button>`;
            }

            html += `<span class="px-3 py-1">Page ${currentPage} of ${totalPages}</span>`;

            if (currentPage < totalPages) {
                html += `<button onclick="changePage(${currentPage + 1})" class="px-3 py-1 border rounded hover:bg-gray-50">Next ‚Üí</button>`;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function changePage(page) {
            currentPage = page;
            renderTable();
        }
        window.changePage = changePage;

        // Export CSV
        function exportCSV() {
            const headers = Object.keys(filteredData[0]);
            let csv = headers.join(',') + '\n';

            filteredData.forEach(row => {
                csv += headers.map(h => `"${row[h] || ''}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `enriched-data-${Date.now()}.csv`;
            a.click();
        }

        loadData();
    </script>
</body>
</html>
